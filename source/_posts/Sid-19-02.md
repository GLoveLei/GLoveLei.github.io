---
title: 'python3.7.2+Django2.0.4 使用django-celery遇到问题'
date: '2019/03/20 14:59:21'
categories:
   - mysql
tags:
   - mysql
toc_level: 3
version: 3
---

#### [](about:blank#1-%E9%A6%96%E5%85%88%E4%B8%BA%E5%95%A5%E8%A6%81%E7%94%A8celery "1) 首先为啥要用celery")1) 首先为啥要用celery

因为在Django Web平台开发中，碰到一些请求执行的任务时间较长（几分钟），为了加快用户的响应时间，因此决定采用异步任务的方式在后台执行这些任务。与此同时，celery除了异步任务，还可以开启定时任务，方便调度。

#### [](about:blank#2-%E5%AE%89%E8%A3%85%E9%9C%80%E8%A6%81%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%8C%85 "2) 安装需要的软件包")2) 安装需要的软件包

```
pip install celery

pip install celery-with-redis

pip install django-celery
```

#### [](about:blank#3-%E5%9B%A0%E4%B8%BAasync%E8%BF%99%E4%B8%AA%E5%8D%95%E8%AF%8D%E5%9C%A8python3-7%E4%B8%AD%E5%B7%B2%E7%BB%8F%E4%BD%9C%E4%B8%BA%E7%B3%BB%E7%BB%9F%E5%85%B3%E9%94%AE%E5%AD%97%E5%AD%98%E5%9C%A8%E4%BA%86%EF%BC%8C%E6%89%80%E4%BB%A5%E8%A6%81%E6%8A%8A%E6%89%80%E6%9C%89%E6%B6%89%E5%8F%8A%E5%88%B0%E8%BF%99%E4%B8%AA%E5%85%B3%E9%94%AE%E5%AD%97%E7%9A%84%E6%96%87%E4%BB%B6%E9%83%BD%E8%A6%81%E6%94%B9%E6%8E%89%EF%BC%8C%E6%B6%89%E5%8F%8A%E7%9A%84%E6%96%87%E4%BB%B6%E5%88%97%E8%A1%A8%E5%8C%85%E5%90%AB%E4%BD%86%E4%B8%8D%E9%99%90%E4%BA%8E%EF%BC%9A "3) 因为async这个单词在python3.7中已经作为系统关键字存在了，所以要把所有涉及到这个关键字的文件都要改掉，涉及的文件列表包含但不限于：")3) 因为async这个单词在python3.7中已经作为系统关键字存在了，所以要把所有涉及到这个关键字的文件都要改掉，涉及的文件列表包含但不限于：

```
/kombu/async

/celery/utils/timer2.py

/concurrency/asynpool.py

/kombu/transport/redis.py

/celery/worker/auto_scale.py,components,consumer,strategy
```

#### [](about:blank#4-%E9%85%8D%E7%BD%AEsettings-py "4) 配置settings.py")4) 配置settings.py

```
INSTALLED_APPS = (
   ...
   'djcelery',
  }
# 末尾初始化
import djcelery
djcelery.setup_loader()
BROKER_URL = 'redis://127.0.0.1:6379/0'
CELERY_IMPORTS = ('应用名称.task')
```

#### [](about:blank#5-%E6%96%B0%E5%A2%9Etask-py "5) 新增task.py")5) 新增task.py

```
#导入异步任务
from celery.task import task
#导入定时任务库
from celery.decorators import periodic_task
  
#利用参数来设置任务周期
@periodic_task(run_every=10)
def some_task():
    print('每10秒执行一次')
    time.sleep(5)
    print('执行完毕')
    return True

#通过装饰器来注册异步任务
@task
def task_mail():
    #实例化一个对象
    sendmail = SendMail('欢迎注册','您的验证码是1324',   ['2910293685@qq.com'],DEFAULT_FROM_EMAIL)
    status = sendmail.do_send_mail()
    if status:
        print('发送邮件成功')
    else:
        print('发送邮件失败')
```

#### [](about:blank#6-%E6%96%B0%E5%A2%9Ecelery-py "6) 新增celery.py")6) 新增celery.py

```
import os
import django
from celery import Celery
from django.conf import settings 
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mymac.settings')
django.setup()
app = Celery('mymac')
app.config_from_object('django.conf:settings')
app.autodiscover_tasks(lambda: settings.INSTALLED_APPS)
@app.task(bind=True)
def debug_task(self):
    print('Request: {0!r}'.format(self.request))
```

#### [](about:blank#7-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1 "7) 启动服务")7) 启动服务

```
#异步服务
celery -A mymac worker -l info  
#定时任务服务
celery -A myproject beat -l info
```

#### [](about:blank#8-%E4%BD%86%E6%98%AF%E6%89%A7%E8%A1%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%97%B6%E5%80%99%E5%8F%91%E7%8E%B0%E6%9C%8D%E5%8A%A1%E8%87%AA%E5%8A%A8%E6%96%AD%E6%8E%89%EF%BC%8C%E6%98%AF%E5%9B%A0%E4%B8%BApython%E5%BA%93%E9%87%8C%E7%9A%84redis%E7%89%88%E6%9C%AC%E5%A4%AA%E9%AB%98%E4%BA%86%E3%80%82%E3%80%82%E3%80%82%E6%89%80%E4%BB%A5%E9%80%9A%E8%BF%87pip%E5%8D%B8%E8%BD%BD%EF%BC%8C%E7%84%B6%E5%90%8E%E6%8C%87%E5%AE%9A%E5%AE%89%E8%A3%85%E4%BD%8E%E7%89%88%E6%9C%AC2-6-10 "8) 但是执行异步任务的时候发现服务自动断掉，是因为python库里的redis版本太高了。。。所以通过pip卸载，然后指定安装低版本2.6.10")8) 但是执行异步任务的时候发现服务自动断掉，是因为python库里的redis版本太高了。。。所以通过pip卸载，然后指定安装低版本2.6.10

```
pip uninstall redis
pip install redis==2.6.10
```

  

