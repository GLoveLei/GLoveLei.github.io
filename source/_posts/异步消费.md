---
title: '异步及异步消费'
date: 2018-02-12 00:00:00 Z
categories: [python]
tags: [异步消费]
toc_level: 3
version: 3
---
![cover](images/lake.png)

### 一、asyncio
同步代码:

```js
import time


def hello():
    time.sleep(1)


def run():
    for i in range(5):
        hello()
        print('Hello World:%s' % time.time())  


if __name__ == '__main__':
    run()
```
输出：
```js
Hello World:1527595175
Hello World:1527595176
Hello World:1527595177
Hello World:1527595178
Hello World:1527595179
```

异步代码:
```js
import time
import asyncio


# 定义异步函数
async def hello():
    asyncio.sleep(1)
    print('Hello World:%s' % time.time())


def run():
    for i in range(5):
        loop.run_until_complete(hello())


loop = asyncio.get_event_loop()
if __name__ =='__main__':
    run()
```
输出:
```js
Hello World:1527595104
Hello World:1527595104
Hello World:1527595104
Hello World:1527595104
Hello World:1527595104
```



async def 用来定义异步函数，其内部有异步操作。每个线程有一个事件循环，主线程调用asyncio.get_event_loop()时会创建事件循环，你需要把异步的任务丢给这个循环的run_until_complete()方法，事件循环会安排协同程序的执行。


### 二、控制任务
通过asyncio.wait()可以控制多任务

asyncio.wait()是一个协程，不会阻塞，立即返回，返回的是协程对象。传入的参数是future或协程构成的可迭代对象。最后将返回值传给run_until_complete()加入事件循环

```js
import asyncio
 
async def coroutine_example(name):
    print('正在执行:', name)
    await asyncio.sleep(1)
    print('执行完毕:', name)
 
loop = asyncio.get_event_loop()
 
tasks = [coroutine_example('nb' + str(i)) for i in range(3)]
wait_coro = asyncio.wait(tasks)
loop.run_until_complete(wait_coro)
loop.close()
```

输出结果:
```js
正在执行:nb_1
正在执行:nb_0
正在执行:nb_2
执行完毕:nb_1
执行完毕:nb_0
执行完毕:nb_2
``` 